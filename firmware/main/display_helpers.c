#include "display_helpers.h"
#include "esp_log.h"
#include <math.h>

uint32_t display_buffer[8][15] = {
        {0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x0CFF00, 0x0CFF00, 0x200000, 0x200000},
        {0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x0CFF00, 0x0CFF00, 0x200000, 0x200000},
        {0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000},
        {0x200000, 0xE5FF00, 0xFFFFFF, 0x200000, 0x200000, 0x200000, 0x0CFF00, 0x0CFF00, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000},
        {0x200000, 0xE5FF00, 0xFFF000, 0x200000, 0x200000, 0x200000, 0x0CFF00, 0x0CFF00, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000},
        {0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x0CFF00, 0x0CFF00, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000},
        {0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x0CFF00, 0x0CFF00, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x0CFF00},
        {0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x0CFF00, 0x0CFF00, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x200000, 0x0CFF00}
};

uint32_t display_bt_buffer[8][15] = {
        {0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000}
};

uint32_t display_bt_logo_buffer[8][15] = {
        {0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x0000FF, 0x000000, 0x000000, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x0000FF, 0x0000FF, 0x0000FF, 0x000000, 0x000000},
        {0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000, 0x000000}
};

// Define the digit patterns (5x3 pixels each)
const uint32_t digit_patterns[10][5] = {
        {0x7, 0x5, 0x5, 0x5, 0x7}, // 0
        {0x2, 0x2, 0x2, 0x2, 0x2}, // 1
        {0x7, 0x1, 0x7, 0x4, 0x7}, // 2
        {0x7, 0x1, 0x7, 0x1, 0x7}, // 3
        {0x5, 0x5, 0x7, 0x1, 0x1}, // 4
        {0x7, 0x4, 0x7, 0x1, 0x7}, // 5
        {0x7, 0x4, 0x7, 0x5, 0x7}, // 6
        {0x7, 0x1, 0x1, 0x1, 0x1}, // 7
        {0x7, 0x5, 0x7, 0x5, 0x7}, // 8
        {0x7, 0x5, 0x7, 0x1, 0x7}  // 9
};

// Define the letter patterns (5x3 pixels each)
const uint32_t letter_patterns[26][5] = {
        {0x7, 0x5, 0x7, 0x5, 0x5}, // A
        {0x7, 0x5, 0x7, 0x5, 0x7}, // B
        {0x7, 0x4, 0x4, 0x4, 0x7}, // C
        {0x7, 0x5, 0x5, 0x5, 0x7}, // D
        {0x7, 0x4, 0x7, 0x4, 0x7}, // E
        {0x7, 0x4, 0x7, 0x4, 0x4}, // F
        {0x7, 0x4, 0x4, 0x5, 0x7}, // G
        {0x5, 0x5, 0x7, 0x5, 0x5}, // H
        {0x7, 0x2, 0x2, 0x2, 0x7}, // I
        {0x7, 0x1, 0x1, 0x1, 0x7}, // J
        {0x5, 0x5, 0x7, 0x5, 0x5}, // K
        {0x4, 0x4, 0x4, 0x4, 0x7}, // L
        {0x5, 0x7, 0x7, 0x5, 0x5}, // M
        {0x5, 0x7, 0x7, 0x5, 0x5}, // N
        {0x7, 0x5, 0x5, 0x5, 0x7}, // O
        {0x7, 0x5, 0x7, 0x4, 0x4}, // P
        {0x7, 0x5, 0x5, 0x5, 0x7}, // Q
        {0x7, 0x5, 0x7, 0x5, 0x5}, // R
        {0x7, 0x4, 0x7, 0x1, 0x7}, // S
        {0x7, 0x2, 0x2, 0x2, 0x2}, // T
        {0x5, 0x5, 0x5, 0x5, 0x7}, // U
        {0x5, 0x5, 0x5, 0x5, 0x2}, // V
        {0x5, 0x5, 0x7, 0x7, 0x5}, // W
        {0x5, 0x5, 0x2, 0x5, 0x5}, // X
        {0x5, 0x5, 0x2, 0x2, 0x2}, // Y
        {0x7, 0x1, 0x2, 0x4, 0x7}  // Z
};


// Function to limit a color component, R, G, B separately
uint8_t limit_brightness(uint8_t color, uint8_t max_brightness) {
    return (color * max_brightness) / 255;
}

// works on the display_buffer array
// adjusts ordering -- odd row reversed
// adjusts brightness
// writes to the new state buffer passed in as a pointer
void display_write_buffer(struct led_state * new_state){
    int led_num = 0;
    // convert the buffer to our screen xy
    for(int i = 0; i < 8; i++){
        for (int j = 0; j < 15; j++){

            // break out the r g b
            uint8_t r = display_buffer[i][j] >> 16;
            uint8_t g = display_buffer[i][j] >> 8;
            uint8_t b = display_buffer[i][j] >> 0;

            if(i % 2 != 0){
                // odd, have to reverse it
                r = display_buffer[i][14 - j] >> 16;
                g = display_buffer[i][14 - j] >> 8;
                b = display_buffer[i][14 - j] >> 0;
            }


            // Apply brightness limit
            r = limit_brightness(r, 30);
            g = limit_brightness(g, 30);
            b = limit_brightness(b, 30);

            // re-arrange rgb to grb and write it to the array
            new_state->leds[led_num] = (((uint32_t)g) << 16) | (((uint32_t)r) << 8) | (((uint32_t)b) << 0);
            led_num++;
        }
    }
}

// converts a uint32_t number to separate digits and writes them to the global buffer
void display_number(uint32_t number, int start_x, int start_y) {
    int digits[4] = {0};
    int digit_count = 0;

    // Handle the case when number is 0
    if (number == 0) {
        digits[0] = 0;
        digit_count = 1;
    } else {
        // Extract digits
        while (number > 0 && digit_count < 4) {
            digits[digit_count++] = number % 10;
            number /= 10;
        }
    }

    // Display digits from left to right
    for (int i = digit_count - 1; i >= 0; i--) {
        int digit = digits[i];
        int x = start_x + (digit_count - 1 - i) * 4; // 4 columns per digit including space

        for (int row = 0; row < 5; row++) {
            for (int col = 0; col < 3; col++) {
                if (digit_patterns[digit][row] & (0x4 >> col)) {
                    display_buffer[start_y + row][x + col] = 0x3F3FFF;
                }
            }
        }
    }
}

// clears the entire buffer
void display_clear(void){
    for (int i = 0; i < 8; i++) {
        for (int b = 0; b < 15; b++) {
            display_buffer[i][b] = 0x000000;
        }
    }
}



void display_draw_bt_logo(void){

    // logo did not look great, we will simply write BLE
    // letter_patterns
    // 1 - B
    // 11 - L
    // 4 - E

//    for(int i = 0; i < 4; i++){
//        for(int b = 0; b < 5; b++){
//            if((letter_patterns[1] >> i) & 0x1 == 0x1){
//                // write this bit to the screen
//                display_buffer[]
//            }
//        }
//    }

    for(int i = 0; i < 8; i++){
        for(int b = 0; b < 15; b++){
            display_buffer[i][b] = display_bt_logo_buffer[i][b];
        }
    }
}

// Function to convert HSV to RGB
// h - hue
// s - saturation
// v - brightness
uint32_t hsv_to_rgb(float h, float s, float v) {
    float c = v * s;
    float x = c * (1 - fabsf(fmodf(h * 6, 2) - 1));
    float m = v - c;
    float r, g, b;

    if (h < 1.0f/6.0f) {
        r = c; g = x; b = 0;
    } else if (h < 2.0f/6.0f) {
        r = x; g = c; b = 0;
    } else if (h < 3.0f/6.0f) {
        r = 0; g = c; b = x;
    } else if (h < 4.0f/6.0f) {
        r = 0; g = x; b = c;
    } else if (h < 5.0f/6.0f) {
        r = x; g = 0; b = c;
    } else {
        r = c; g = 0; b = x;
    }

    uint8_t r_int = (uint8_t)((r + m) * 255);
    uint8_t g_int = (uint8_t)((g + m) * 255);
    uint8_t b_int = (uint8_t)((b + m) * 255);

    return (r_int << 16) | (g_int << 8) | b_int;
}